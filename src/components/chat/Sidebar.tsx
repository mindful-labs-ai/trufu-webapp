'use client';

import { useFriendStore } from '@/stores/friendStore';
import { useFriendsQuery } from '@/hooks/queries/useFriendsQuery';
import { useLatestChatSummaryQuery } from '@/hooks/queries/useLatestChatSummaryQuery';
import type { Friend } from '@/types/friend';
import { useMemo } from 'react';
import { useUserStore } from '@/stores/userStore';

interface SidebarProps {
  isOpen: boolean;
  onClose: () => void;
}

export const Sidebar = ({ isOpen, onClose }: SidebarProps) => {
  const { selectedFriend, selectFriend } = useFriendStore();
  const { data: availableFriends = [], isLoading } = useFriendsQuery();
  const currentUser = useUserStore(s => s.me);
  const { data: chatSummaries = [] } = useLatestChatSummaryQuery(
    currentUser?.id ?? null
  );

  const lastMessageMap = useMemo(() => {
    return chatSummaries.reduce<Record<string, string | undefined>>(
      (acc, summary) => {
        acc[summary.botId] = summary.lastMessage?.content;
        return acc;
      },
      {}
    );
  }, [chatSummaries]);

  return (
    <>
      {isOpen && (
        <div
          className="fixed inset-0 bg-black/50 z-40 lg:hidden"
          onClick={onClose}
        />
      )}

      <div
        className={`
          fixed lg:relative z-50 lg:z-auto
          w-80 h-full bg-sidebar border-r border-sidebar-border
          transform transition-transform duration-300 ease-in-out
          ${isOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}
        `}
      >
        <div className="flex flex-col h-full">
          <div className="p-4 h-16 border-b border-sidebar-border">
            <div className="flex items-center justify-between">
              <svg
                className="h-8 w-auto fill-primary"
                viewBox="0 0 1182 568"
                xmlns="http://www.w3.org/2000/svg"
              >
                <g clipPath="url(#clip0_1975_2465)">
                  <path d="M188.391 438.892C186.611 438.342 187.031 432.042 187.131 430.242C187.471 423.912 189.261 417.012 189.621 410.572C193.061 348.162 196.121 285.842 198.631 223.402C199.191 209.552 199.641 195.462 200.271 181.542C200.381 179.182 202.221 170.522 201.891 169.362C201.521 168.052 200.211 168.112 199.111 167.992C187.131 166.612 161.381 167.112 148.961 168.022C132.691 169.222 113.031 175.052 99.0207 183.782C85.0107 192.512 75.5507 203.972 68.4307 218.052C65.8507 221.262 63.7307 214.692 62.7307 212.352C45.9007 172.802 61.5907 134.312 99.0107 114.822C129.661 98.8617 171.761 96.3217 206.491 97.4017C240.571 98.4717 274.691 106.062 309.151 103.212C316.421 102.612 323.061 98.3517 329.021 94.3417C341.811 85.7417 356.081 73.4017 354.711 56.4017C355.251 55.8017 361.641 61.3017 362.531 62.1217C368.341 67.4417 375.371 77.2717 374.031 85.4817C373.931 86.0917 370.911 91.7217 373.971 90.8417C388.341 86.7117 403.811 67.7617 406.241 53.3017C406.511 51.6817 406.391 49.2617 407.681 49.0117C419.991 65.5417 423.191 86.6517 422.101 106.912C419.121 162.142 370.351 183.062 321.491 183.662C306.361 183.852 291.751 180.752 276.681 181.152C276.571 191.652 276.401 202.262 275.851 212.752C272.301 281.062 269.241 351.842 271.721 420.462C271.901 425.562 272.811 431.712 273.421 436.852C273.511 437.542 272.571 438.892 272.161 438.892H188.391Z" />
                  <path d="M820.389 281.29C820.189 284.3 821.779 286.98 822.019 289.92C827.739 357.94 844.129 478.94 765.339 512.34C738.219 523.83 699.019 523.59 679.119 499.24C679.889 497.95 680.809 498.2 681.989 497.99C703.449 494.27 719.569 484.72 731.389 466.1C753.559 431.17 750.399 391.23 750.539 351.51C750.619 328.11 750.549 304.69 750.579 281.3H720.599C720.139 281.3 719.339 279.92 719.369 279.25C717.899 256.97 718.469 234.57 719.369 212.35H740.309C740.399 212.35 741.539 211.21 741.539 211.12L743.199 177.38C743.199 176.61 743.539 173.76 743.809 172.35C750.569 136.61 770.559 112.56 806.459 102.81C816.729 100.02 824.969 97.6598 836.359 97.3898C852.769 97.0098 868.599 97.8498 882.759 106.1C895.279 113.4 899.089 123.9 897.619 138.09C897.009 144.03 893.259 154.06 890.209 159.42C889.479 160.71 882.939 169.51 882.309 169.64C868.769 158.99 852.819 154.46 835.549 155.69C817.069 157 805.079 168.54 806.589 187.45C806.829 190.41 806.969 193.17 807.229 196.27C807.719 202.31 806.019 211.52 813.399 212.37C828.489 214.11 849.699 212.04 865.169 211.54C867.169 211.48 878.709 210.88 878.709 212.76V280.07C878.709 280.16 877.569 281.3 877.479 281.3H820.399L820.389 281.29Z" />
                  <path d="M974.27 365.559C983.77 381.099 1003.33 382.279 1018.5 374.629C1038.03 364.769 1042.55 341.939 1044.6 321.909C1047.57 292.829 1049.48 254.829 1044.4 226.099C1043.96 223.629 1040.57 214.609 1040.73 213.939C1041.21 211.969 1044.47 212.359 1045.8 212.389C1066.06 212.819 1086.38 212.009 1106.65 212.309C1110.08 212.769 1113.16 215.839 1113.63 219.289C1115.04 254.689 1111.63 291.669 1113.56 326.889C1113.94 333.809 1113.86 341.009 1114.21 348.029C1114.63 356.489 1115.24 366.199 1116.07 374.449C1117.11 384.759 1119.66 400.429 1123.05 410.159C1123.52 411.499 1124.99 412.549 1125.14 413.919C1125.48 417.169 1115.99 427.629 1113.18 429.849C1089.86 448.209 1056.81 445.129 1052 412.219C1051.85 411.209 1052.46 410.669 1050.77 410.979C1048.46 411.399 1041.93 419.459 1039.4 421.369C1009 444.269 940.35 451.999 914.5 419.149C910.72 414.349 908.91 409.299 906.59 404.229C896.93 383.079 896.87 359.229 895.93 335.109C894.62 301.399 895.94 268.579 897.64 234.969C897.82 231.389 896.94 214.599 897.96 213.129C898.55 212.289 899.56 212.429 900.44 212.319C911.97 210.929 929.35 212.369 941.58 212.389C945.17 212.389 948.57 212.349 952.19 212.389C957.36 212.449 965.67 211.549 970.29 212.359C973.58 212.929 971.53 215.249 971.49 217.659C971.11 237.339 967.49 257.859 966.57 277.579C965.57 298.849 963.72 348.279 974.29 365.569L974.27 365.559Z" />
                  <path d="M564.439 365.561C573.939 381.101 593.509 382.281 608.669 374.631C628.269 364.731 632.719 342.011 634.769 321.911C637.739 292.791 639.659 254.881 634.569 226.101C634.129 223.631 630.759 214.701 630.929 214.031C631.409 212.061 634.649 212.361 635.979 212.391C656.239 212.821 676.559 212.011 696.829 212.311C700.259 212.771 703.339 215.841 703.809 219.291C705.219 254.691 700.999 291.731 702.929 326.951C703.309 333.871 703.409 341.291 703.749 348.311C704.169 356.771 705.409 366.201 706.239 374.451C707.279 384.781 709.839 400.401 713.219 410.161C713.679 411.501 715.179 412.561 715.299 413.911C715.609 417.431 706.259 427.541 703.339 429.841C680.009 448.201 646.969 445.121 642.159 412.211C642.009 411.201 642.619 410.661 640.929 410.971C638.619 411.391 632.089 419.451 629.559 421.361C599.259 444.181 531.089 451.871 505.009 419.611C502.459 416.451 500.349 411.751 498.429 408.281C487.319 388.151 486.939 359.591 486.089 335.101C484.909 301.431 486.029 269.401 487.759 235.741C487.949 232.111 487.139 214.541 488.129 213.121C488.719 212.281 489.729 212.421 490.609 212.311C502.139 210.921 519.519 212.361 531.749 212.381C535.339 212.381 538.739 212.341 542.359 212.381C547.529 212.441 555.839 211.541 560.459 212.351C563.749 212.921 561.699 215.241 561.659 217.651C561.279 237.321 557.689 257.861 556.739 277.571C555.719 298.801 553.909 348.311 564.459 365.561H564.439Z" />
                  <path d="M394.13 438.891H321.03C321.38 410.581 320.58 382.221 321 353.901C321.67 308.711 325.36 264.791 316.06 220.181C315.84 219.111 311.66 212.341 314.87 212.341H367.43C367.76 212.341 372.27 215.501 372.81 215.991C376.85 219.701 377.62 224.811 378.88 229.621C379.3 231.211 379.23 232.971 379.39 234.161C379.64 236.101 378.73 238.921 382.21 239.431C389.02 230.101 397.63 223.791 407.46 218.051C422.08 209.501 439.57 205.791 456.99 207.391C460.64 207.721 464.78 209.411 468.05 211.121V284.171C468.05 284.461 466.82 285.571 466.02 285.391C465.19 285.201 458.19 278.741 456.49 277.661C431.41 261.681 401.04 283.811 395.19 309.851C394.18 314.361 392.79 322.291 392.46 326.821C389.95 361.231 394.54 396.841 395.02 431.081C395.06 433.871 394.25 436.201 394.13 438.891Z" />
                </g>
                <defs>
                  <clipPath id="clip0_1975_2465">
                    <rect
                      width="1069.15"
                      height="470.7"
                      fill="white"
                      transform="translate(56 49)"
                    />
                  </clipPath>
                </defs>
              </svg>
              <button
                onClick={onClose}
                className="lg:hidden p-1 rounded-md hover:bg-muted transition-colors"
              >
                <svg
                  className="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            </div>
          </div>

          <div className="flex-1 overflow-y-auto p-4 space-y-2">
            <div className="mb-4">
              <h2 className="text-sm font-medium text-muted-foreground mb-2">
                대화 친구들
              </h2>
            </div>
            {isLoading ? (
              <div className="flex justify-center items-center py-8">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
              </div>
            ) : (
              availableFriends.map((friend: Friend) => (
                <div
                  key={friend.id}
                  onClick={() => selectFriend(friend)}
                  className={`
                  p-3 rounded-lg cursor-pointer transition-colors duration-200
                  ${
                    selectedFriend?.id === friend.id
                      ? 'bg-muted'
                      : 'hover:bg-muted'
                  }
                `}
                >
                  <div className="flex items-center space-x-3">
                    <div className="w-10 h-10 rounded-full flex items-center justify-center bg-gradient-to-r from-primary to-secondary text-primary-foreground font-semibold text-sm">
                      {friend?.name?.charAt(0)}
                    </div>

                    <div className="flex-1">
                      <h3 className="font-medium text-sm line-clamp-1">
                        {friend.name}
                      </h3>
                      <p className="text-xs mt-1 line-clamp-1 text-muted-foreground">
                        {lastMessageMap[friend.id] || friend.description}
                      </p>
                    </div>
                  </div>
                </div>
              ))
            )}
          </div>
        </div>
      </div>
    </>
  );
};
